{% extends "base.html" %}
{% block title %}Hub Stats{% endblock %}
{% block content %}
<h2>Hub Stats</h2>
<p>Real-time Hub statistics (updates every 3 seconds)</p>

<h3>General</h3>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 2rem;">
    <!-- Active Users -->
    <div class="card">
        <h3>Active Users</h3>
        <div style="margin: 1rem 0;">
            <p><strong>Total IPs:</strong> <span id="total-ips">--</span></p>
            <p><strong>Online IPs:</strong> <span id="online-ips">--</span></p>
        </div>
    </div>

    <!-- Usernames -->
    <div class="card">
        <h3>Usernames</h3>
        <div style="margin: 1rem 0;">
            <p><strong>Total Usernames:</strong> <span id="total-usernames">--</span></p>
            <p><strong>Average Usernames/IP:</strong> <span id="average-usernames-per-ip">--</span></p>
        </div>
    </div>

    <!-- Server Uptime -->
    <div class="card">
        <h3>Server Uptime</h3>
        <div style="margin: 1rem 0;">
            <p><span id="server-uptime">--</span></p>
        </div>
    </div>
</div>

<h3>Features</h3>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 2rem;">
    <!-- Chat -->
    <div class="card">
        <h3>Chat</h3>
        <div style="margin: 1rem 0;">
            <p><strong>Total Messages:</strong> <span id="total-chat-messages">--</span></p>
            <p><strong>Messages in Memory:</strong> <span id="chat-messages-in-memory">--</span></p>
        </div>
    </div>
</div>

<div style="margin-top: 2rem; text-align: center; color: #666;">
    <p>Last updated: <span id="last-updated">--</span></p>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const socket = io("/hub-stats");


socket.on("stats_update", updateStats);

function updateStats(data) {
    // ips
    document.getElementById("total-ips").textContent = data.ips.total_ips;
    document.getElementById("online-ips").textContent = data.ips.online_ips;

    //usernames
    document.getElementById("total-usernames").textContent = data.usernames.total_usernames;
    document.getElementById("average-usernames-per-ip").textContent = data.usernames.average_usernames_per_ip;

    // server uptime
    const uptimeSeconds = data.server_uptime_seconds;
    const uptimeHours = Math.floor(uptimeSeconds / 3600);
    const uptimeMinutes = Math.floor((uptimeSeconds % 3600) / 60);
    const uptimeSecondsRemaining = uptimeSeconds % 60;
    document.getElementById("server-uptime").textContent = `${uptimeHours}h ${uptimeMinutes}m ${uptimeSecondsRemaining}s`;

    // Features - Chat
    document.getElementById("total-chat-messages").textContent = data.features.chat.total_messages;
    document.getElementById("chat-messages-in-memory").textContent = data.features.chat.messages_in_memory;

    const date = new Date(data.timestamp);
    document.getElementById("last-updated").textContent = date.toLocaleTimeString();
}

socket.on("connect", () => {
  console.log("Socket connected to /hub-stats, sid:", socket.id);
  socket.emit("subscribe_stats", {});
});

socket.on("connect_error", (err) => {
  console.error("Socket connect error:", err);
});
</script>
{% endblock %}